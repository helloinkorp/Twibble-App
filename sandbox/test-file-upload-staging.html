<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test File Upload Staging Fix</title>
    <link rel="stylesheet" href="src/styles/design-system.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            padding: 20px;
            background: #f8fafc;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #1e293b;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-pass { background: #10b981; }
        .status-fail { background: #ef4444; }
        .status-pending { background: #f59e0b; }
        
        .file-drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f9fafb;
            cursor: pointer;
        }
        
        .file-drop-zone.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .test-container-box {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
        }
        
        .test-container-box h4 {
            margin: 0 0 15px 0;
            font-size: 14px;
            color: #64748b;
        }
        
        .word-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: move;
        }
        
        .word-chip.temp-chip.vocabulary {
            background: #fef3cd;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        
        .word-chip.temp-chip.spelling {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .word-chip.temp-chip.phonics {
            background: #e9d5ff;
            border: 1px solid #a855f7;
            color: #6b21a8;
        }
        
        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #ef4444;
            font-size: 10px;
            padding: 0;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .log-area {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ File Upload Staging System Test</h1>
        <p><strong>Purpose:</strong> Validate that file upload creates staged chips in grids and only updates Word Pool after button press.</p>
        
        <!-- Test 1: File Upload Staging -->
        <div class="test-section">
            <h3><span id="test1-status" class="status-indicator status-pending"></span>Test 1: File Upload to Staging</h3>
            <p>Upload a TXT file and verify words appear in staging (not Word Pool).</p>
            
            <div class="file-drop-zone" id="testFileDropZone">
                <input type="file" accept=".txt" id="testFileInput" style="position: absolute; opacity: 0;">
                <div>üìÅ Drop TXT file here or click to browse</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Test file should contain: cat, dog, bird, fish</div>
            </div>
            
            <!-- File Upload Staging Grids -->
            <div class="test-grid">
                <div class="test-container-box">
                    <h4>File Upload - Vocabulary (Staging)</h4>
                    <div id="file-vocabulary-staging" data-group="file-vocabulary"></div>
                </div>
                <div class="test-container-box">
                    <h4>File Upload - Spelling (Staging)</h4>
                    <div id="file-spelling-staging" data-group="file-spelling"></div>
                </div>
                <div class="test-container-box">
                    <h4>File Upload - Phonics (Staging)</h4>
                    <div id="file-phonics-staging" data-group="file-phonics"></div>
                </div>
            </div>
        </div>
        
        <!-- Test 2: Drag and Drop Between File Grids -->
        <div class="test-section">
            <h3><span id="test2-status" class="status-indicator status-pending"></span>Test 2: Drag-Drop Between File Grids</h3>
            <p>Drag words between file upload staging grids to test inter-grid movement.</p>
            <button class="btn btn-secondary" onclick="testDragDrop()">Simulate Drag-Drop Test</button>
        </div>
        
        <!-- Test 3: Button Press to Move to Word Pool -->
        <div class="test-section">
            <h3><span id="test3-status" class="status-indicator status-pending"></span>Test 3: Button Press to Word Pool</h3>
            <p>Press button to move all staged file upload words to Word Pool.</p>
            <button class="btn btn-primary" id="testAddToPoolBtn">Add File Upload Words to Lesson</button>
            
            <div class="test-container-box" style="margin-top: 15px;">
                <h4>Word Pool (Final Destination)</h4>
                <div id="wordPoolContainer"></div>
            </div>
        </div>
        
        <!-- Test Log -->
        <div class="test-section">
            <h3>üìù Test Log</h3>
            <div id="testLog" class="log-area">Test initialized. Upload a file to begin testing...\n</div>
        </div>
    </div>
    
    <script>
        // Test state management
        let fileUploadStorage = {
            'file-vocabulary': [],
            'file-spelling': [],
            'file-phonics': []
        };
        
        let wordPool = [];
        let testResults = {
            test1: 'pending',
            test2: 'pending', 
            test3: 'pending'
        };
        
        // Logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('testLog');
            const colorClass = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            logArea.innerHTML += `[${timestamp}] <span class="${colorClass}">${message}</span>\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        // Update test status indicators
        function updateTestStatus(testId, status) {
            testResults[testId] = status;
            const indicator = document.getElementById(`${testId}-status`);
            indicator.className = `status-indicator status-${status}`;
        }
        
        // Initialize file upload
        function initializeFileUpload() {
            const dropZone = document.getElementById('testFileDropZone');
            const fileInput = document.getElementById('testFileInput');
            
            // Drag and drop handlers
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
            
            // Click handler
            dropZone.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
        }
        
        // Handle file upload to staging
        function handleFileUpload(file) {
            if (!file.name.toLowerCase().endsWith('.txt')) {
                log('‚ùå Error: Only TXT files are supported', 'error');
                updateTestStatus('test1', 'fail');
                return;
            }
            
            log(`üìÑ Reading file: ${file.name}`, 'info');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const words = parseWords(content);
                
                if (words.length > 0) {
                    log(`‚úÖ Found ${words.length} words: ${words.join(', ')}`, 'success');
                    
                    // Add to staging (not Word Pool yet!)
                    words.forEach(word => {
                        const cleanWord = word.trim();
                        if (!fileUploadStorage['file-vocabulary'].includes(cleanWord)) {
                            fileUploadStorage['file-vocabulary'].push(cleanWord);
                        }
                    });
                    
                    // Update staging display
                    updateFileUploadStagingDisplay('file-vocabulary');
                    
                    log(`üìã Added ${words.length} words to file-vocabulary staging`, 'success');
                    log(`‚ö†Ô∏è Words are NOT in Word Pool yet - button press required`, 'warning');
                    
                    updateTestStatus('test1', 'pass');
                    
                    // Check if Word Pool was incorrectly updated
                    if (wordPool.length > 0) {
                        log('‚ùå FAIL: Words appeared in Word Pool before button press!', 'error');
                        updateTestStatus('test1', 'fail');
                    } else {
                        log('‚úÖ PASS: Words correctly staged, Word Pool remains empty', 'success');
                    }
                } else {
                    log('‚ùå No valid words found in file', 'error');
                    updateTestStatus('test1', 'fail');
                }
            };
            
            reader.onerror = () => {
                log('‚ùå Error reading file', 'error');
                updateTestStatus('test1', 'fail');
            };
            
            reader.readAsText(file);
        }
        
        // Parse words from text
        function parseWords(text) {
            if (!text.trim()) return [];
            
            return text.split(/[\\s,\\n]+/)
                .map(word => word.trim().replace(/[^\\w\\s-']/g, ''))
                .filter(word => word.length > 0 && /[a-zA-Z]/.test(word))
                .map(word => word.toLowerCase());
        }
        
        // Update staging display
        function updateFileUploadStagingDisplay(groupType) {
            const container = document.getElementById(`${groupType}-staging`);
            if (!container) return;
            
            container.innerHTML = '';
            
            fileUploadStorage[groupType].forEach(word => {
                const chip = createStagingChip(word, groupType);
                container.appendChild(chip);
            });
        }
        
        // Create staging chip
        function createStagingChip(word, groupType) {
            const chip = document.createElement('div');
            chip.className = 'word-chip temp-chip';
            chip.textContent = word;
            chip.setAttribute('data-word', word);
            chip.setAttribute('data-group', groupType);
            chip.draggable = true;
            
            // Add activity color class
            if (groupType === 'file-vocabulary') {
                chip.classList.add('vocabulary');
            } else if (groupType === 'file-spelling') {
                chip.classList.add('spelling');
            } else if (groupType === 'file-phonics') {
                chip.classList.add('phonics');
            }
            
            // Drag handlers
            chip.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', word);
                e.dataTransfer.setData('source-group', groupType);
                e.dataTransfer.effectAllowed = 'move';
            });
            
            // Delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '√ó';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                removeFromStaging(word, groupType);
            });
            
            chip.appendChild(deleteBtn);
            return chip;
        }
        
        // Remove from staging
        function removeFromStaging(word, groupType) {
            const index = fileUploadStorage[groupType].indexOf(word);
            if (index > -1) {
                fileUploadStorage[groupType].splice(index, 1);
                updateFileUploadStagingDisplay(groupType);
                log(`üóëÔ∏è Removed "${word}" from ${groupType} staging`, 'info');
            }
        }
        
        // Setup drag-drop between containers
        function setupStagingDragDrop() {
            const containers = [
                document.getElementById('file-vocabulary-staging'),
                document.getElementById('file-spelling-staging'), 
                document.getElementById('file-phonics-staging')
            ];
            
            containers.forEach(container => {
                if (container) {
                    container.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        container.style.background = '#f0f9ff';
                    });
                    
                    container.addEventListener('dragleave', (e) => {
                        container.style.background = '';
                    });
                    
                    container.addEventListener('drop', (e) => {
                        e.preventDefault();
                        container.style.background = '';
                        
                        const word = e.dataTransfer.getData('text/plain');
                        const sourceGroup = e.dataTransfer.getData('source-group');
                        const targetGroup = container.getAttribute('data-group');
                        
                        if (word && sourceGroup && targetGroup && sourceGroup !== targetGroup) {
                            moveWordBetweenStaging(word, sourceGroup, targetGroup);
                        }
                    });
                }
            });
        }
        
        // Move word between staging containers
        function moveWordBetweenStaging(word, sourceGroup, targetGroup) {
            const index = fileUploadStorage[sourceGroup].indexOf(word);
            if (index > -1) {
                // Remove from source
                fileUploadStorage[sourceGroup].splice(index, 1);
                // Add to target
                if (!fileUploadStorage[targetGroup].includes(word)) {
                    fileUploadStorage[targetGroup].push(word);
                }
                
                // Update displays
                updateFileUploadStagingDisplay(sourceGroup);
                updateFileUploadStagingDisplay(targetGroup);
                
                log(`üîÑ Moved "${word}" from ${sourceGroup} to ${targetGroup}`, 'success');
                updateTestStatus('test2', 'pass');
            }
        }
        
        // Test drag-drop programmatically
        function testDragDrop() {
            if (fileUploadStorage['file-vocabulary'].length > 0) {
                const wordToMove = fileUploadStorage['file-vocabulary'][0];
                moveWordBetweenStaging(wordToMove, 'file-vocabulary', 'file-spelling');
                log(`üß™ Test: Simulated moving "${wordToMove}" to spelling staging`, 'info');
            } else {
                log('‚ö†Ô∏è No words in staging to test drag-drop. Upload a file first.', 'warning');
            }
        }
        
        // Move all staging to Word Pool
        function moveAllStagingToWordPool() {
            let totalMoved = 0;
            
            ['file-vocabulary', 'file-spelling', 'file-phonics'].forEach(groupType => {
                const words = fileUploadStorage[groupType];
                words.forEach(word => {
                    if (!wordPool.includes(word)) {
                        wordPool.push(word);
                        totalMoved++;
                    }
                });
                
                // Clear staging
                fileUploadStorage[groupType] = [];
                updateFileUploadStagingDisplay(groupType);
            });
            
            updateWordPoolDisplay();
            
            if (totalMoved > 0) {
                log(`‚úÖ SUCCESS: Moved ${totalMoved} words to Word Pool`, 'success');
                updateTestStatus('test3', 'pass');
                
                // Final validation
                if (isAllTestsPassed()) {
                    log('üéâ ALL TESTS PASSED! File upload staging system working correctly.', 'success');
                }
            } else {
                log('‚ö†Ô∏è No words to move to Word Pool', 'warning');
            }
        }
        
        // Update Word Pool display
        function updateWordPoolDisplay() {
            const container = document.getElementById('wordPoolContainer');
            container.innerHTML = '';
            
            if (wordPool.length === 0) {
                container.innerHTML = '<div style="color: #6b7280; font-style: italic;">No words in Word Pool yet</div>';
                return;
            }
            
            wordPool.forEach(word => {
                const chip = document.createElement('div');
                chip.className = 'word-chip';
                chip.style.background = '#f3f4f6';
                chip.style.border = '1px solid #d1d5db';
                chip.style.color = '#374151';
                chip.textContent = word;
                container.appendChild(chip);
            });
        }
        
        // Check if all tests passed
        function isAllTestsPassed() {
            return Object.values(testResults).every(status => status === 'pass');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ File Upload Staging Test initialized', 'info');
            initializeFileUpload();
            setupStagingDragDrop();
            updateWordPoolDisplay();
            
            // Button handler
            document.getElementById('testAddToPoolBtn').addEventListener('click', () => {
                log('üîÑ Button pressed: Moving staged words to Word Pool...', 'info');
                moveAllStagingToWordPool();
            });
            
            log('üìã Ready for testing. Upload a TXT file to begin.', 'info');
        });
    </script>
</body>
</html>