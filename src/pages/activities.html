<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Activities - Twibble</title>
    <meta name="description" content="Complete interactive vocabulary, phonics, and spelling activities">
    
    <!-- Design System CSS -->
    <link rel="stylesheet" href="../styles/design-system.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,300,0,0" rel="stylesheet">
    
    <style>
        /* Ensure Material Symbols font loads properly */
        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
    </style>
    
    <style>
        /* Activities page specific styles using design tokens - Mobile-First */
        .page-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--color-background);
        }
        
        .activities-header {
            background-color: var(--color-white);
            border-bottom: 1px solid var(--color-gray-200);
            padding: var(--space-4);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 64px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .progress-indicator {
            font-family: var(--font-family-headers);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-gray-600);
            text-align: center;
            flex: 1;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-6);
            min-height: calc(100vh - 64px);
        }
        
        .activity-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .activity-card {
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--space-8);
            box-shadow: var(--shadow-card);
            text-align: center;
        }
        
        .activity-type {
            font-family: var(--font-family-headers);
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
            color: var(--color-gray-700);
            margin-bottom: var(--space-4);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .word-display {
            font-family: var(--font-family-headers);
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-medium);
            color: var(--color-black);
            margin-bottom: var(--space-6);
            word-break: break-word;
        }
        
        .activity-content {
            margin-bottom: var(--space-8);
        }
        
        .activity-actions {
            display: flex;
            gap: var(--space-4);
            justify-content: center;
            flex-wrap: wrap;
        }
        
        /* Vocabulary Activities */
        .flip-card-container {
            perspective: 1000px;
            height: 200px;
            margin-bottom: var(--space-6);
        }
        
        .flip-card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        
        .flip-card.flipped {
            transform: rotateY(180deg);
        }
        
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-6);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-card);
        }
        
        .card-front {
            background-color: var(--color-card-bg);
        }
        
        .card-back {
            background-color: var(--color-card-bg-soft);
            transform: rotateY(180deg);
        }
        
        .card-text {
            font-family: var(--font-family-headers);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-medium);
            color: var(--color-black);
            text-align: center;
        }
        
        .card-definition {
            font-family: var(--font-family-body);
            font-size: var(--font-size-base);
            color: var(--color-gray-700);
            text-align: center;
            line-height: var(--line-height-relaxed);
        }
        
        /* MCQ Activities */
        .mcq-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-3);
            margin-bottom: var(--space-6);
        }
        
        .mcq-option {
            background-color: var(--color-white);
            border: 2px solid var(--color-gray-300);
            border-radius: var(--border-radius-lg);
            padding: var(--space-4);
            font-family: var(--font-family-body);
            font-size: var(--font-size-base);
            color: var(--color-black);
            cursor: pointer;
            transition: all var(--transition-base);
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .mcq-option:hover,
        .mcq-option:focus {
            border-color: var(--color-primary);
            background-color: var(--color-primary-light);
        }
        
        .mcq-option.selected {
            border-color: var(--color-primary);
            background-color: var(--color-primary);
            color: var(--color-white);
        }
        
        .mcq-option.correct {
            border-color: var(--color-success);
            background-color: var(--color-success);
            color: var(--color-white);
        }
        
        .mcq-option.incorrect {
            border-color: var(--color-error);
            background-color: var(--color-error);
            color: var(--color-white);
        }
        
        /* Phonics Activities */
        .phonics-chunks {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            justify-content: center;
            margin-bottom: var(--space-6);
        }
        
        .chunk {
            background-color: var(--color-primary-light);
            color: var(--color-black);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--border-radius-md);
            font-family: var(--font-family-headers);
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
            border: 2px solid var(--color-primary);
        }
        
        .assembly-area {
            background-color: var(--color-gray-100);
            border: 2px dashed var(--color-gray-400);
            border-radius: var(--border-radius-lg);
            padding: var(--space-6);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--space-6);
            text-align: center;
        }
        
        .assembly-area.drag-over {
            border-color: var(--color-primary);
            background-color: var(--color-primary-light);
        }
        
        .assembly-placeholder {
            font-family: var(--font-family-body);
            font-size: var(--font-size-base);
            color: var(--color-gray-500);
        }
        
        /* Spelling Activities */
        .letter-slots {
            display: flex;
            gap: var(--space-2);
            justify-content: center;
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
        }
        
        .letter-slot {
            width: 48px;
            height: 48px;
            border: 2px solid var(--color-gray-300);
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-family-headers);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-medium);
            background-color: var(--color-white);
            cursor: pointer;
        }
        
        .letter-slot.filled {
            border-color: var(--color-success);
            color: var(--color-success);
        }
        
        .letter-options {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            justify-content: center;
            margin-bottom: var(--space-6);
        }
        
        .letter-option {
            width: 40px;
            height: 40px;
            border: 1px solid var(--color-gray-400);
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-family-headers);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            background-color: var(--color-gray-100);
            cursor: move;
            user-select: none;
        }
        
        .letter-option:hover {
            background-color: var(--color-gray-200);
        }
        
        .letter-option.used {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* Touch-friendly controls */
        .nav-button {
            min-width: 48px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: var(--border-radius-md);
            transition: background-color var(--transition-base);
            padding: var(--space-2) var(--space-3);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }
        
        .nav-button:hover {
            background-color: var(--color-gray-100);
        }
        
        
        /* Loading and completion states */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
            color: var(--color-gray-600);
        }
        
        .completion-message {
            text-align: center;
            padding: var(--space-8);
        }
        
        .completion-title {
            font-family: var(--font-family-headers);
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-medium);
            color: var(--color-success);
            margin-bottom: var(--space-4);
        }
        
        .completion-text {
            font-family: var(--font-family-body);
            font-size: var(--font-size-base);
            color: var(--color-gray-600);
            margin-bottom: var(--space-6);
        }
        
        /* Responsive Design */
        @media (min-width: 640px) {
            .activities-header {
                padding: var(--space-6);
            }
            
            .main-content {
                padding: var(--space-8);
            }
            
            .activity-container {
                max-width: 600px;
            }
            
            .mcq-options {
                grid-template-columns: 1fr 1fr;
            }
            
            .letter-slots {
                gap: var(--space-3);
            }
            
            .letter-slot {
                width: 56px;
                height: 56px;
            }
        }
        
        @media (min-width: 768px) {
            .activity-container {
                max-width: 700px;
            }
            
            .activity-card {
                padding: var(--space-12);
            }
            
            .word-display {
                font-size: var(--font-size-4xl);
            }
        }
        
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Focus states */
        .nav-button:focus,
        .mcq-option:focus,
        .letter-slot:focus,
        .letter-option:focus,
        .flip-card:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div class="page-container">
        <!-- Header with Home Button and Avatar -->
        <header id="page-header" role="banner">
            <!-- Header will be populated by JavaScript -->
        </header>
        
        <!-- Activities Navigation Header -->
        <div class="activities-header">
            <div class="header-left">
                <!-- Home button now handled by main header -->
            </div>
            
            <div class="progress-indicator">
                <span id="progressText">Loading...</span>
            </div>
            
            <div class="header-right">
                <button class="nav-button" id="skipBtn" aria-label="Skip current activity">
                    Skip
                </button>
                <button class="nav-button" id="exitBtn" aria-label="Save progress and exit">
                    Exit
                </button>
            </div>
        </div>

        <!-- Main Activity Content -->
        <main id="main-content" class="main-content">
            <div class="activity-container">
                <div class="activity-card" id="activityCard">
                    <!-- Loading State -->
                    <div class="loading" id="loadingState">
                        <span class="material-symbols-outlined">hourglass_empty</span>
                        <span>Loading activity...</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Component Dependencies (ES6 Modules) -->
    
    <!-- JavaScript Module -->
    <script type="module">
        // Use consolidated navigation system - createHeader is now in NavigationUtils
        import '../js/navigation.js';
        import { createCtaButton, createSecondaryButton } from '../components/buttons.js';
        import { createFlippableCard, createWordChip, createLetterAssembly } from '../components/interactive.js';
        
        // Activities page controller with mobile-first design and accessibility

        // State management
        let currentState = {
            lessonId: null,
            dayNumber: null,
            activities: [],
            currentActivityIndex: 0,
            progress: {},
            words: []
        };

        // Sample lesson data for prototype
        const SAMPLE_LESSON_DATA = {
            id: 'lesson-001',
            title: 'Animal Kingdom',
            days: {
                1: {
                    words: [
                        {
                            id: 'word-1',
                            word: 'elephant',
                            definition: 'A large mammal with a trunk and big ears',
                            phonics: ['el', 'e', 'phant'],
                            difficulty: 'medium',
                            status: 'new'
                        },
                        {
                            id: 'word-2', 
                            word: 'butterfly',
                            definition: 'A colorful insect with delicate wings',
                            phonics: ['but', 'ter', 'fly'],
                            difficulty: 'easy',
                            status: 'new'
                        },
                        {
                            id: 'word-3',
                            word: 'penguin',
                            definition: 'A black and white bird that swims but cannot fly',
                            phonics: ['pen', 'guin'],
                            difficulty: 'medium',
                            status: 'review'
                        }
                    ]
                }
            }
        };

        // Activity types and flow
        const ACTIVITY_TYPES = ['vocabulary', 'phonics', 'spelling'];
        const ACTIVITY_ORDER = {
            new: ACTIVITY_TYPES,      // NEW words: V → P → S
            review: ACTIVITY_TYPES    // REVIEW words: V → P → S
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            initializePage();
            setupEventListeners();
        });

        function initializePage() {
            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            currentState.lessonId = urlParams.get('lesson') || 'lesson-001';
            currentState.dayNumber = parseInt(urlParams.get('day')) || 1;

            // Validate student role (basic check)
            const userRole = localStorage.getItem('userRole');
            if (userRole !== 'student') {
                redirectToHome();
                return;
            }

            // Setup header
            setupHeader();

            // Load lesson data
            loadLessonData();
        }
        
        // Setup consistent header
        function setupHeader() {
            const headerContainer = document.getElementById('page-header');
            
            // Load user data
            const userSettingsStr = localStorage.getItem('userSettings');
            let userSettings = null;
            if (userSettingsStr) {
                try {
                    userSettings = JSON.parse(userSettingsStr);
                } catch (error) {
                    console.error('Error parsing user settings:', error);
                }
            }
            
            const header = window.NavigationUtils.createHeader({
                showHome: true,
                user: userSettings,
                onHome: () => {
                    redirectToHome();
                },
                onProfile: () => {
                    redirectToHome();
                },
                title: ''
            });

            headerContainer.appendChild(header);
        }

        function loadLessonData() {
            // In production, this would fetch from API
            // Using sample data for prototype
            const lessonData = SAMPLE_LESSON_DATA;
            const dayData = lessonData.days[currentState.dayNumber];
            
            if (!dayData) {
                showError('Day not found');
                return;
            }

            currentState.words = dayData.words;
            generateActivityFlow();
            loadProgress();
            startActivities();
        }

        function generateActivityFlow() {
            const activities = [];
            
            // First: NEW words (V → P → S)
            const newWords = currentState.words.filter(word => word.status === 'new');
            newWords.forEach(word => {
                ACTIVITY_ORDER.new.forEach(activityType => {
                    activities.push({
                        word: word,
                        type: activityType,
                        status: word.status
                    });
                });
            });

            // Then: REVIEW words (V → P → S) 
            const reviewWords = currentState.words.filter(word => word.status === 'review');
            reviewWords.forEach(word => {
                ACTIVITY_ORDER.review.forEach(activityType => {
                    activities.push({
                        word: word,
                        type: activityType,
                        status: word.status
                    });
                });
            });

            currentState.activities = activities;
            currentState.currentActivityIndex = 0;
        }

        function loadProgress() {
            // Load existing progress from localStorage
            const progressKey = `lesson_${currentState.lessonId}_day_${currentState.dayNumber}`;
            const savedProgress = localStorage.getItem(progressKey);
            
            if (savedProgress) {
                try {
                    currentState.progress = JSON.parse(savedProgress);
                } catch (e) {
                    currentState.progress = {};
                }
            } else {
                currentState.progress = {};
            }
        }

        function saveProgress() {
            const progressKey = `lesson_${currentState.lessonId}_day_${currentState.dayNumber}`;
            localStorage.setItem(progressKey, JSON.stringify(currentState.progress));
        }

        function startActivities() {
            if (currentState.activities.length === 0) {
                showCompletion();
                return;
            }

            updateProgressIndicator();
            renderCurrentActivity();
        }

        function updateProgressIndicator() {
            const progressText = document.getElementById('progressText');
            const current = currentState.currentActivityIndex + 1;
            const total = currentState.activities.length;
            progressText.textContent = `Activity ${current} of ${total}`;
        }

        function renderCurrentActivity() {
            const activityCard = document.getElementById('activityCard');
            const loadingState = document.getElementById('loadingState');
            
            if (currentState.currentActivityIndex >= currentState.activities.length) {
                showCompletion();
                return;
            }

            const activity = currentState.activities[currentState.currentActivityIndex];
            loadingState.style.display = 'none';
            
            switch (activity.type) {
                case 'vocabulary':
                    renderVocabularyActivity(activity);
                    break;
                case 'phonics':
                    renderPhonicsActivity(activity);
                    break;
                case 'spelling':
                    renderSpellingActivity(activity);
                    break;
            }
        }

        function renderVocabularyActivity(activity) {
            const activityCard = document.getElementById('activityCard');
            const isNew = activity.status === 'new';
            
            if (isNew) {
                // NEW mode: Flippable card
                activityCard.innerHTML = `
                    <div class="activity-type">Vocabulary</div>
                    <div class="word-display">${activity.word.word}</div>
                    <div class="activity-content">
                        <div class="flip-card-container">
                            <div class="flip-card" id="flipCard" tabindex="0" role="button" aria-label="Flip card to see definition">
                                <div class="card-face card-front">
                                    <div class="card-text">Click to see definition</div>
                                </div>
                                <div class="card-face card-back">
                                    <div class="card-definition">${activity.word.definition}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="activity-actions">
                        <button class="btn btn-primary btn-lg" id="continueBtn">Continue</button>
                    </div>
                `;

                setupFlipCard();
            } else {
                // REVIEW mode: MCQ
                renderMCQActivity(activity);
            }

            setupActivityActions();
        }

        function renderMCQActivity(activity) {
            const activityCard = document.getElementById('activityCard');
            const correctAnswer = activity.word.definition;
            
            // Generate wrong answers (simplified for prototype)
            const wrongAnswers = [
                'A small insect that flies around flowers',
                'A type of tree that grows in forests', 
                'A musical instrument played with hands'
            ];
            
            const options = [correctAnswer, ...wrongAnswers].sort(() => Math.random() - 0.5);
            
            activityCard.innerHTML = `
                <div class="activity-type">Vocabulary Review</div>
                <div class="word-display">${activity.word.word}</div>
                <div class="activity-content">
                    <div class="mcq-options" id="mcqOptions">
                        ${options.map((option, index) => `
                            <div class="mcq-option" data-option="${option}" data-correct="${option === correctAnswer}" 
                                 tabindex="0" role="button" aria-label="Option ${index + 1}: ${option}">
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="activity-actions">
                    <button class="btn btn-secondary btn-lg" id="continueBtn" disabled>Select an answer</button>
                </div>
            `;

            setupMCQOptions();
            setupActivityActions();
        }

        function renderPhonicsActivity(activity) {
            const activityCard = document.getElementById('activityCard');
            const isNew = activity.status === 'new';
            
            if (isNew) {
                // NEW mode: Display chunks
                activityCard.innerHTML = `
                    <div class="activity-type">Phonics</div>
                    <div class="word-display">${activity.word.word}</div>
                    <div class="activity-content">
                        <div class="phonics-chunks">
                            ${activity.word.phonics.map(chunk => `
                                <div class="chunk">${chunk}</div>
                            `).join('')}
                        </div>
                        <p style="color: var(--color-gray-600); font-size: var(--font-size-base); text-align: center;">
                            These are the sound chunks that make up the word
                        </p>
                    </div>
                    <div class="activity-actions">
                        <button class="btn btn-primary btn-lg" id="continueBtn">Continue</button>
                    </div>
                `;
            } else {
                // REVIEW mode: Assembly area (simplified for prototype)
                const shuffledChunks = [...activity.word.phonics].sort(() => Math.random() - 0.5);
                
                activityCard.innerHTML = `
                    <div class="activity-type">Phonics Review</div>
                    <div class="word-display">Build the word</div>
                    <div class="activity-content">
                        <div class="assembly-area" id="assemblyArea">
                            <div class="assembly-placeholder">Drag chunks here to build the word</div>
                        </div>
                        <div class="phonics-chunks">
                            ${shuffledChunks.map((chunk, index) => `
                                <div class="chunk" draggable="true" data-chunk="${chunk}" data-index="${index}">${chunk}</div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="activity-actions">
                        <button class="btn btn-secondary btn-lg" id="continueBtn" disabled>Build the word first</button>
                    </div>
                `;

                setupDragAndDrop();
            }

            setupActivityActions();
        }

        function renderSpellingActivity(activity) {
            const activityCard = document.getElementById('activityCard');
            const isNew = activity.status === 'new';
            
            if (isNew) {
                // NEW mode: Letter reveal
                const letters = activity.word.word.split('');
                
                activityCard.innerHTML = `
                    <div class="activity-type">Spelling</div>
                    <div class="word-display">${activity.word.word}</div>
                    <div class="activity-content">
                        <div class="letter-slots">
                            ${letters.map((letter, index) => `
                                <div class="letter-slot filled">${letter.toUpperCase()}</div>
                            `).join('')}
                        </div>
                        <p style="color: var(--color-gray-600); font-size: var(--font-size-base); text-align: center;">
                            Study how the word is spelled
                        </p>
                    </div>
                    <div class="activity-actions">
                        <button class="btn btn-primary btn-lg" id="continueBtn">Continue</button>
                    </div>
                `;
            } else {
                // REVIEW mode: Spelling assembly
                const letters = activity.word.word.split('');
                const extraLetters = ['b', 'r', 'x', 'z', 'q'];
                const allLetters = [...letters, ...extraLetters].sort(() => Math.random() - 0.5);
                
                activityCard.innerHTML = `
                    <div class="activity-type">Spelling Review</div>
                    <div class="word-display">Spell the word</div>
                    <div class="activity-content">
                        <div class="letter-slots" id="letterSlots">
                            ${letters.map((letter, index) => `
                                <div class="letter-slot" data-position="${index}" data-target="${letter.toLowerCase()}"></div>
                            `).join('')}
                        </div>
                        <div class="letter-options">
                            ${allLetters.map((letter, index) => `
                                <div class="letter-option" draggable="true" data-letter="${letter.toLowerCase()}">${letter.toUpperCase()}</div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="activity-actions">
                        <button class="btn btn-secondary btn-lg" id="continueBtn" disabled>Complete the spelling</button>
                    </div>
                `;

                setupSpellingDragDrop();
            }

            setupActivityActions();
        }

        function setupFlipCard() {
            const flipCard = document.getElementById('flipCard');
            if (!flipCard) return;

            const toggleFlip = () => {
                flipCard.classList.toggle('flipped');
                const isFlipped = flipCard.classList.contains('flipped');
                flipCard.setAttribute('aria-label', isFlipped ? 'Flip card to see word' : 'Flip card to see definition');
            };

            flipCard.addEventListener('click', toggleFlip);
            flipCard.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleFlip();
                }
            });
        }

        function setupMCQOptions() {
            const options = document.querySelectorAll('.mcq-option');
            const continueBtn = document.getElementById('continueBtn');

            options.forEach(option => {
                const clickHandler = () => {
                    // Remove previous selections
                    options.forEach(opt => {
                        opt.classList.remove('selected', 'correct', 'incorrect');
                    });

                    // Mark selection
                    option.classList.add('selected');
                    
                    const isCorrect = option.getAttribute('data-correct') === 'true';
                    
                    setTimeout(() => {
                        if (isCorrect) {
                            option.classList.remove('selected');
                            option.classList.add('correct');
                            continueBtn.textContent = 'Correct! Continue';
                            continueBtn.disabled = false;
                            continueBtn.className = 'btn btn-primary btn-lg';
                        } else {
                            option.classList.remove('selected');
                            option.classList.add('incorrect');
                            
                            // Show correct answer
                            const correctOption = document.querySelector('.mcq-option[data-correct="true"]');
                            if (correctOption) {
                                correctOption.classList.add('correct');
                            }
                            
                            continueBtn.textContent = 'Try again or Continue';
                            continueBtn.disabled = false;
                            continueBtn.className = 'btn btn-secondary btn-lg';
                        }
                    }, 500);
                };

                option.addEventListener('click', clickHandler);
                option.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        clickHandler();
                    }
                });
            });
        }

        function setupDragAndDrop() {
            const assemblyArea = document.getElementById('assemblyArea');
            const chunks = document.querySelectorAll('.chunk[draggable="true"]');
            const continueBtn = document.getElementById('continueBtn');
            let assembledChunks = [];

            chunks.forEach(chunk => {
                chunk.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', chunk.getAttribute('data-chunk'));
                    chunk.style.opacity = '0.5';
                });

                chunk.addEventListener('dragend', () => {
                    chunk.style.opacity = '1';
                });
            });

            assemblyArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                assemblyArea.classList.add('drag-over');
            });

            assemblyArea.addEventListener('dragleave', () => {
                assemblyArea.classList.remove('drag-over');
            });

            assemblyArea.addEventListener('drop', (e) => {
                e.preventDefault();
                assemblyArea.classList.remove('drag-over');
                
                const chunkText = e.dataTransfer.getData('text/plain');
                assembledChunks.push(chunkText);
                
                // Hide the dragged chunk
                const draggedChunk = document.querySelector(`[data-chunk="${chunkText}"]`);
                if (draggedChunk) {
                    draggedChunk.style.display = 'none';
                }
                
                // Update assembly area
                assemblyArea.innerHTML = `
                    <div style="font-family: var(--font-family-headers); font-size: var(--font-size-lg); color: var(--color-black);">
                        ${assembledChunks.join(' - ')}
                    </div>
                `;
                
                // Check if complete
                const activity = currentState.activities[currentState.currentActivityIndex];
                if (assembledChunks.length === activity.word.phonics.length) {
                    const isCorrect = assembledChunks.join('') === activity.word.phonics.join('');
                    
                    if (isCorrect) {
                        assemblyArea.style.borderColor = 'var(--color-success)';
                        assemblyArea.style.backgroundColor = 'var(--color-success)';
                        assemblyArea.style.color = 'white';
                        continueBtn.textContent = 'Correct! Continue';
                        continueBtn.disabled = false;
                        continueBtn.className = 'btn btn-primary btn-lg';
                    } else {
                        assemblyArea.style.borderColor = 'var(--color-error)';
                        continueBtn.textContent = 'Try again or Continue';
                        continueBtn.disabled = false;
                        continueBtn.className = 'btn btn-secondary btn-lg';
                    }
                }
            });
        }

        function setupSpellingDragDrop() {
            const letterSlots = document.querySelectorAll('.letter-slot');
            const letterOptions = document.querySelectorAll('.letter-option');
            const continueBtn = document.getElementById('continueBtn');
            let filledSlots = 0;

            letterOptions.forEach(option => {
                option.addEventListener('dragstart', (e) => {
                    if (option.classList.contains('used')) {
                        e.preventDefault();
                        return;
                    }
                    e.dataTransfer.setData('text/plain', option.getAttribute('data-letter'));
                    option.style.opacity = '0.5';
                });

                option.addEventListener('dragend', () => {
                    option.style.opacity = '1';
                });
            });

            letterSlots.forEach(slot => {
                slot.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (!slot.textContent) {
                        slot.style.borderColor = 'var(--color-primary)';
                        slot.style.backgroundColor = 'var(--color-primary-light)';
                    }
                });

                slot.addEventListener('dragleave', () => {
                    slot.style.borderColor = 'var(--color-gray-300)';
                    slot.style.backgroundColor = 'var(--color-white)';
                });

                slot.addEventListener('drop', (e) => {
                    e.preventDefault();
                    
                    if (slot.textContent) return; // Already filled
                    
                    const letter = e.dataTransfer.getData('text/plain');
                    const targetLetter = slot.getAttribute('data-target');
                    
                    slot.textContent = letter.toUpperCase();
                    slot.classList.add('filled');
                    slot.style.borderColor = 'var(--color-success)';
                    slot.style.backgroundColor = 'var(--color-white)';
                    
                    // Mark letter as used
                    const usedOption = document.querySelector(`[data-letter="${letter}"]`);
                    if (usedOption) {
                        usedOption.classList.add('used');
                    }
                    
                    filledSlots++;
                    
                    if (filledSlots === letterSlots.length) {
                        // Check if correct
                        const activity = currentState.activities[currentState.currentActivityIndex];
                        const spelled = Array.from(letterSlots).map(slot => slot.textContent.toLowerCase()).join('');
                        const correct = activity.word.word.toLowerCase();
                        
                        if (spelled === correct) {
                            letterSlots.forEach(s => {
                                s.style.borderColor = 'var(--color-success)';
                                s.style.color = 'var(--color-success)';
                            });
                            continueBtn.textContent = 'Correct! Continue';
                            continueBtn.disabled = false;
                            continueBtn.className = 'btn btn-primary btn-lg';
                        } else {
                            letterSlots.forEach(s => {
                                s.style.borderColor = 'var(--color-error)';
                                s.style.color = 'var(--color-error)';
                            });
                            continueBtn.textContent = 'Try again or Continue';
                            continueBtn.disabled = false;
                            continueBtn.className = 'btn btn-secondary btn-lg';
                        }
                    }
                });

                // Click to clear
                slot.addEventListener('click', () => {
                    if (slot.textContent) {
                        const letter = slot.textContent.toLowerCase();
                        const option = document.querySelector(`[data-letter="${letter}"]`);
                        if (option) {
                            option.classList.remove('used');
                        }
                        
                        slot.textContent = '';
                        slot.classList.remove('filled');
                        slot.style.borderColor = 'var(--color-gray-300)';
                        slot.style.color = 'var(--color-black)';
                        filledSlots--;
                        
                        continueBtn.disabled = true;
                        continueBtn.textContent = 'Complete the spelling';
                        continueBtn.className = 'btn btn-secondary btn-lg';
                    }
                });
            });
        }

        function setupActivityActions() {
            const continueBtn = document.getElementById('continueBtn');
            if (continueBtn) {
                continueBtn.addEventListener('click', () => {
                    completeActivity();
                });
            }
        }

        function completeActivity() {
            const activity = currentState.activities[currentState.currentActivityIndex];
            
            // Mark activity as completed
            const activityKey = `${activity.word.id}_${activity.type}`;
            currentState.progress[activityKey] = {
                completed: true,
                timestamp: new Date().toISOString()
            };
            
            saveProgress();
            
            // Move to next activity
            currentState.currentActivityIndex++;
            
            if (currentState.currentActivityIndex >= currentState.activities.length) {
                showCompletion();
            } else {
                updateProgressIndicator();
                renderCurrentActivity();
            }
        }

        function skipActivity() {
            const activity = currentState.activities[currentState.currentActivityIndex];
            const activityKey = `${activity.word.id}_${activity.type}`;
            
            currentState.progress[activityKey] = {
                completed: false,
                skipped: true,
                timestamp: new Date().toISOString()
            };
            
            saveProgress();
            
            currentState.currentActivityIndex++;
            
            if (currentState.currentActivityIndex >= currentState.activities.length) {
                showCompletion();
            } else {
                updateProgressIndicator();
                renderCurrentActivity();
            }
        }

        function showCompletion() {
            const activityCard = document.getElementById('activityCard');
            const progressText = document.getElementById('progressText');
            
            progressText.textContent = 'Complete!';
            
            activityCard.innerHTML = `
                <div class="completion-message">
                    <div class="completion-title">Great Job!</div>
                    <div class="completion-text">
                        You have completed all activities for Day ${currentState.dayNumber}.
                        Your progress has been saved automatically.
                    </div>
                    <div class="activity-actions">
                        <button class="btn btn-primary btn-lg" id="returnToDashboard">Return to Dashboard</button>
                    </div>
                </div>
            `;
            
            document.getElementById('returnToDashboard').addEventListener('click', () => {
                returnToStudentDashboard();
            });
        }

        function showError(message) {
            const activityCard = document.getElementById('activityCard');
            activityCard.innerHTML = `
                <div class="completion-message">
                    <div class="completion-title" style="color: var(--color-error);">Error</div>
                    <div class="completion-text">${message}</div>
                    <div class="activity-actions">
                        <button class="btn btn-secondary btn-lg" id="goHome">Go Home</button>
                    </div>
                </div>
            `;
            
            document.getElementById('goHome').addEventListener('click', redirectToHome);
        }

        function setupEventListeners() {
            const skipBtn = document.getElementById('skipBtn'); 
            const exitBtn = document.getElementById('exitBtn');

            skipBtn.addEventListener('click', skipActivity);
            exitBtn.addEventListener('click', confirmExit);
        }

        function redirectToHome() {
            if (window.navigationManager) {
                window.navigationManager.goHome();
            } else {
                window.location.href = 'index.html';
            }
        }

        function returnToStudentDashboard() {
            if (window.navigationManager) {
                window.navigationManager.goBack();
            } else {
                window.location.href = `student-dashboard.html?lesson=${currentState.lessonId}`;
            }
        }

        function confirmExit() {
            saveProgress();
            
            createModal({
                title: 'Save Progress',
                content: '<p>Your progress has been saved. Return to the dashboard?</p>',
                actions: [
                    {
                        text: 'Stay Here',
                        variant: 'secondary'
                    },
                    {
                        text: 'Go to Dashboard', 
                        variant: 'primary',
                        onClick: () => returnToStudentDashboard()
                    }
                ]
            });
        }

        // Export for testing
        window.activitiesController = {
            currentState,
            completeActivity,
            skipActivity,
            loadLessonData
        };
    </script>
    
    <!-- Navigation System -->
    <script src="../js/navigation.js"></script>
</body>
</html>